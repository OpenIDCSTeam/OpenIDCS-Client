{% extends "base.html" %}

{% block content %}
<!-- 页面标题 -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
        <span class="iconify text-blue-600" data-icon="mdi:server" data-width="36"></span>
        主机管理
    </h1>
    <p class="text-gray-600 mt-1">管理所有虚拟化主机</p>
</div>

<!-- 操作栏 -->
<div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
    <div class="flex items-center gap-4">
        <button onclick="openAddHostModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium btn-hover shadow-sm flex items-center gap-2">
            <span class="iconify" data-icon="mdi:plus" data-width="18"></span>
            添加主机
        </button>
        <button onclick="loadHosts()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium btn-hover flex items-center gap-2">
            <span class="iconify" data-icon="mdi:refresh" data-width="18"></span>
            刷新
        </button>
    </div>
    <div class="text-sm text-gray-500 flex items-center gap-2">
        <span class="iconify" data-icon="mdi:information-outline" data-width="16"></span>
        共 <span id="hostCount" class="font-medium text-gray-700">0</span> 个主机
    </div>
</div>

<!-- 主机列表 -->
<div id="hostsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <div class="col-span-full text-center py-16 text-gray-500">
        <span class="iconify animate-pulse-slow text-gray-400" data-icon="mdi:loading" data-width="48"></span>
        <p class="mt-4">加载中...</p>
    </div>
</div>

<!-- 添加/编辑主机模态框 -->
<dialog id="hostModal" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg flex items-center gap-2" id="modalTitle">
            <span class="iconify text-blue-600" data-icon="mdi:server-plus" data-width="24"></span>
            添加主机
        </h3>
        <form id="hostForm" class="mt-4 space-y-4">
            <input type="hidden" name="editMode" id="editMode" value="add">
            <input type="hidden" name="originalName" id="originalName" value="">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器名称 *</label>
                    <input type="text" name="name" id="hostName" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="例如: host1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器类型 *</label>
                    <select name="type" id="hostType" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">请选择类型</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器地址</label>
                    <input type="text" name="server_addr" id="serverAddr"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="例如: localhost:8697">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器用户</label>
                    <input type="text" name="server_user" id="serverUser"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="例如: root">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器密码</label>
                    <input type="password" name="server_pass" id="serverPass"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="服务器密码">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">虚拟机前缀</label>
                    <input type="text" name="filter_name" id="filterName"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="过滤器名称">
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:folder" data-width="18"></span>
                    存储路径配置
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">镜像存储路径</label>
                        <input type="text" name="images_path" id="imagesPath"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: /data/images">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">系统存储路径</label>
                        <input type="text" name="system_path" id="systemPath"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: /data/system">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">备份存储路径</label>
                        <input type="text" name="backup_path" id="backupPath"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: /data/backup">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">数据存储路径</label>
                        <input type="text" name="extern_path" id="externPath"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: /data/extern">
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">程序启动路径</label>
                    <input type="text" name="launch_path" id="launchPath"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="虚拟化程序路径">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">共享IP设备名</label>
                    <input type="text" name="network_nat" id="networkNat"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="例如: nat">
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">独立IP设备名</label>
                    <input type="text" name="network_pub" id="networkPub"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="例如: pub">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器公网IP</label>
                    <input type="text" name="public_addr" id="publicAddr"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="例如: 192.168.1.1, 2001:db8::1">
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:router-network" data-width="18"></span>
                    爱快OS配置
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">爱快OS地址</label>
                        <input type="text" name="i_kuai_addr" id="iKuaiAddr"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: http://192.168.1.1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">爱快OS用户名</label>
                        <input type="text" name="i_kuai_user" id="iKuaiUser"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="爱快OS管理员用户名">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">爱快OS密码</label>
                        <input type="password" name="i_kuai_pass" id="iKuaiPass"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="爱快OS管理员密码">
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:network-outline" data-width="18"></span>
                    端口配置
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">TCP端口起始</label>
                        <input type="number" name="ports_start" id="portsStart"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: 10000" min="0" max="65535">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">TCP端口结束</label>
                        <input type="number" name="ports_close" id="portsClose"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: 20000" min="0" max="65535">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">VNC服务端口</label>
                        <input type="number" name="remote_port" id="remotePort"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: 5900" min="0" max="65535">
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:file-table-outline" data-width="18"></span>
                    系统映射配置
                </h4>
                <div class="mb-3">
                    <p class="text-sm text-gray-600">配置系统名称与镜像文件的映射关系</p>
                </div>
                <div id="systemMapsContainer" class="space-y-2">
                    <!-- 系统映射行将动态添加到这里 -->
                </div>
                <div class="mt-3">
                    <button type="button" onclick="addSystemMapRow()" 
                        class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 flex items-center gap-1">
                        <span class="iconify" data-icon="mdi:plus" data-width="16"></span>
                        添加系统映射
                    </button>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">API扩展选项 (JSON格式)</label>
                <textarea name="extend_data" id="extendData" rows="2"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder='{"key": "value"}'></textarea>
            </div>
            
            <div class="modal-action">
                <button type="button" onclick="document.getElementById('hostModal').close()" 
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    保存
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 删除确认模态框 -->
<dialog id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg flex items-center gap-2 text-red-600">
            <span class="iconify" data-icon="mdi:alert-circle" data-width="24"></span>
            确认删除
        </h3>
        <p class="py-4">确定要删除主机 "<span id="deleteHostName" class="font-medium"></span>" 吗？此操作不可恢复。</p>
        <div class="modal-action">
            <button onclick="document.getElementById('deleteModal').close()" 
                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="confirmDeleteHost()" 
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                确认删除
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>
{% endblock %}

{% block extra_scripts %}
<script>
    let engineTypes = {};
    let currentDeleteHost = '';
    
    // 渲染公网IP地址（带复制功能）
    function renderPublicAddr(addrs) {
        if (!addrs || !Array.isArray(addrs) || addrs.length === 0) {
            return '未配置';
        }
        return addrs.map(ip => 
            `<span class="cursor-pointer hover:text-blue-600 inline-flex items-center gap-1" onclick="copyToClipboard('${ip}')" title="点击复制">${ip}<span class="iconify text-gray-400 hover:text-blue-600" data-icon="mdi:content-copy" data-width="12"></span></span>`
        ).join('<br>');
    }
    
    // 复制到剪贴板
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('已复制: ' + text, 'success');
        }).catch(() => {
            showToast('复制失败', 'error');
        });
    }
    
    // 解析扩展数据JSON
    function parseExtendData(value) {
        if (!value || !value.trim()) return {};
        try {
            return JSON.parse(value);
        } catch (e) {
            showToast('扩展数据JSON格式错误', 'error');
            return {};
        }
    }
    
    // 系统映射相关函数 =======================================
    
    // 添加系统映射行
    function addSystemMapRow(systemName = '', systemFile = '', minSize = '') {
        const container = document.getElementById('systemMapsContainer');
        const rowId = Date.now() + Math.random();
        const rowHtml = `
            <div class="system-map-row bg-gray-50 p-3 rounded-lg" data-row-id="${rowId}">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                    <div class="md:col-span-5">
                        <label class="block text-xs font-medium text-gray-600 mb-1">外部显示系统名称</label>
                        <input type="text" 
                            class="system-name w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="例如: Windows 10" 
                            value="${systemName}">
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">镜像文件(带后缀)</label>
                        <input type="text" 
                            class="system-file w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="例如: windows10.qcow2" 
                            value="${systemFile}">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">最低大小(GB)</label>
                        <input type="number" 
                            class="min-size w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="例如: 20" 
                            min="0" 
                            step="0.1"
                            value="${minSize}">
                    </div>
                    <div class="md:col-span-1">
                        <button type="button" onclick="removeSystemMapRow('${rowId}')" 
                            class="w-full px-2 py-1.5 bg-red-500 text-white text-sm rounded hover:bg-red-600 flex items-center justify-center gap-1 whitespace-nowrap">
                            <span class="iconify" data-icon="mdi:delete" data-width="14"></span>
                            <span class="hidden sm:inline">删除</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', rowHtml);
    }
    
    // 删除系统映射行
    function removeSystemMapRow(rowId) {
        const row = document.querySelector(`[data-row-id="${rowId}"]`);
        if (row) {
            row.remove();
        }
    }
    
    // 获取系统映射数据
    function getSystemMapsData() {
        const maps = {};
        const rows = document.querySelectorAll('.system-map-row');
        rows.forEach(row => {
            const systemName = row.querySelector('.system-name').value.trim();
            const systemFile = row.querySelector('.system-file').value.trim();
            const minSize = row.querySelector('.min-size').value.trim();
            
            if (systemName && systemFile) {
                maps[systemName] = [systemFile, minSize || '0'];
            }
        });
        return maps;
    }
    
    // 加载系统映射数据
    function loadSystemMapsData(systemMaps) {
        const container = document.getElementById('systemMapsContainer');
        container.innerHTML = ''; // 清空现有内容
        
        if (systemMaps && typeof systemMaps === 'object') {
            for (const [systemName, config] of Object.entries(systemMaps)) {
                if (Array.isArray(config) && config.length >= 2) {
                    addSystemMapRow(systemName, config[0], config[1]);
                } else if (Array.isArray(config) && config.length >= 1) {
                    addSystemMapRow(systemName, config[0], '');
                }
            }
        }
        
        // 如果没有任何映射，添加一个空行作为默认
        if (Object.keys(systemMaps || {}).length === 0) {
            addSystemMapRow();
        }
    }
    
    // 页面加载完成后执行
    $(document).ready(function() {
        loadEngineTypes();
        loadHosts();
    });
    
    // 加载引擎类型
    async function loadEngineTypes() {
        const result = await apiRequest('/api/engine/types');
        if (result && result.code === 200) {
            engineTypes = result.data;
            const select = document.getElementById('hostType');
            select.innerHTML = '<option value="">请选择类型</option>';
            
            for (const [type, config] of Object.entries(engineTypes)) {
                if (config.enabled) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = `${config.description} (${type})`;
                    select.appendChild(option);
                }
            }
        }
    }
    
    // 加载主机列表
    async function loadHosts() {
        const container = document.getElementById('hostsList');
        container.innerHTML = `
            <div class="col-span-full text-center py-16 text-gray-500">
                <span class="iconify animate-pulse-slow text-gray-400" data-icon="mdi:loading" data-width="48"></span>
                <p class="mt-4">加载中...</p>
            </div>
        `;
        
        const result = await apiRequest('/api/hosts');
        if (result && result.code === 200) {
            const hosts = result.data;
            const count = Object.keys(hosts).length;
            document.getElementById('hostCount').textContent = count;
            
            if (count === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <span class="iconify text-gray-300" data-icon="mdi:server-off" data-width="64"></span>
                        <p class="mt-4 text-gray-500">暂无主机</p>
                        <button onclick="openAddHostModal()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                            添加第一个主机
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            for (const [name, host] of Object.entries(hosts)) {
                container.innerHTML += renderHostCard(name, host);
            }
        }
    }
    
    // 渲染主机卡片
    function renderHostCard(name, host) {
        const typeInfo = engineTypes[host.type] || {};
        return `
            <div class="bg-white rounded-lg border border-gray-200 card-hover overflow-hidden">
                <div class="p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                                <span class="iconify text-white" data-icon="mdi:server" data-width="28"></span>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">${name}</h3>
                                <p class="text-sm text-gray-500">${typeInfo.description || host.type}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium ${host.status === 'active' ? 'text-green-700 bg-green-100' : 'text-gray-600 bg-gray-100'} rounded-full flex items-center gap-1">
                            ${host.status === 'active' ? '<span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>' : ''}
                            ${host.status === 'active' ? '运行中' : '已停止'}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-between text-gray-600">
                            <span class="flex items-center gap-1">
                                <span class="iconify" data-icon="mdi:ip-network" data-width="16"></span>
                                地址
                            </span>
                            <span class="font-medium text-gray-800">${host.addr || '未配置'}</span>
                        </div>
                        <div class="flex items-center justify-between text-gray-600">
                            <span class="flex items-center gap-1">
                                <span class="iconify" data-icon="mdi:earth" data-width="16"></span>
                                外网访问IP
                            </span>
                            <span class="font-medium text-gray-800">${renderPublicAddr(host.config?.public_addr)}</span>
                        </div>
                        ${host.config?.i_kuai_addr ? `
                        <div class="flex items-center justify-between text-gray-600">
                            <span class="flex items-center gap-1">
                                <span class="iconify" data-icon="mdi:router-network" data-width="16"></span>
                                爱快OS
                            </span>
                            <span class="font-medium text-gray-800">${host.config.i_kuai_addr}</span>
                        </div>
                        ` : ''}
                        ${host.config?.ports_start && host.config?.ports_close ? `
                        <div class="flex items-center justify-between text-gray-600">
                            <span class="flex items-center gap-1">
                                <span class="iconify" data-icon="mdi:network-outline" data-width="16"></span>
                                端口范围
                            </span>
                            <span class="font-medium text-gray-800">${host.config.ports_start}-${host.config.ports_close}</span>
                        </div>
                        ` : ''}
                        ${host.config?.remote_port ? `
                        <div class="flex items-center justify-between text-gray-600">
                            <span class="flex items-center gap-1">
                                <span class="iconify" data-icon="mdi:remote-desktop" data-width="16"></span>
                                VNC端口
                            </span>
                            <span class="font-medium text-gray-800">${host.config.remote_port}</span>
                        </div>
                        ` : ''}
                        ${host.config?.system_maps && Object.keys(host.config.system_maps).length > 0 ? `
                        <div class="flex items-center justify-between text-gray-600">
                            <span class="flex items-center gap-1">
                                <span class="iconify" data-icon="mdi:file-table-outline" data-width="16"></span>
                                系统映射
                            </span>
                            <span class="font-medium text-gray-800">${Object.keys(host.config.system_maps).length} 个</span>
                        </div>
                        ` : ''}
                        <div class="flex items-center justify-between text-gray-600">
                            <span class="flex items-center gap-1">
                                <span class="iconify" data-icon="mdi:cube-outline" data-width="16"></span>
                                虚拟机
                            </span>
                            <span class="font-medium text-gray-800">${host.vm_count || 0} 台</span>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 px-4 py-3 bg-gray-50 flex items-center justify-between">
                    <a href="/hosts/${name}/vms" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1">
                        <span class="iconify" data-icon="mdi:cube-outline" data-width="16"></span>
                        虚拟机管理
                    </a>
                    <div class="flex items-center gap-2">
                        <button onclick="scanHostVMs('${name}')" 
                            class="p-2 rounded-lg hover:bg-orange-100 text-orange-600" title="扫描虚拟机">
                            <span class="iconify" data-icon="mdi:radar" data-width="18"></span>
                        </button>
                        <button onclick="toggleHost('${name}', ${host.status !== 'active'})" 
                            class="p-2 rounded-lg hover:bg-gray-200 text-gray-600" title="${host.status === 'active' ? '停止' : '启动'}">
                            <span class="iconify" data-icon="${host.status === 'active' ? 'mdi:stop' : 'mdi:play'}" data-width="18"></span>
                        </button>
                        <button onclick="editHost('${name}')" 
                            class="p-2 rounded-lg hover:bg-gray-200 text-gray-600" title="编辑">
                            <span class="iconify" data-icon="mdi:pencil" data-width="18"></span>
                        </button>
                        <button onclick="deleteHost('${name}')" 
                            class="p-2 rounded-lg hover:bg-red-100 text-red-600" title="删除">
                            <span class="iconify" data-icon="mdi:delete" data-width="18"></span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 打开添加主机模态框
    function openAddHostModal() {
        document.getElementById('modalTitle').innerHTML = `
            <span class="iconify text-blue-600" data-icon="mdi:server-plus" data-width="24"></span>
            添加主机
        `;
        document.getElementById('editMode').value = 'add';
        document.getElementById('hostForm').reset();
        document.getElementById('hostName').disabled = false;
        // 初始化系统映射为空
        loadSystemMapsData({});
        document.getElementById('hostModal').showModal();
    }
    
    // 编辑主机
    async function editHost(name) {
        const result = await apiRequest(`/api/hosts/${name}`);
        if (result && result.code === 200) {
            const host = result.data;
            
            document.getElementById('modalTitle').innerHTML = `
                <span class="iconify text-blue-600" data-icon="mdi:server-edit" data-width="24"></span>
                编辑主机
            `;
            document.getElementById('editMode').value = 'edit';
            document.getElementById('originalName').value = name;
            document.getElementById('hostName').value = name;
            document.getElementById('hostName').disabled = true;
            document.getElementById('hostType').value = host.type;
            
            const config = host.config || {};
            document.getElementById('serverAddr').value = config.server_addr || '';
            document.getElementById('serverUser').value = config.server_user || '';
            document.getElementById('serverPass').value = config.server_pass || '';
            document.getElementById('filterName').value = config.filter_name || '';
            document.getElementById('imagesPath').value = config.images_path || '';
            document.getElementById('systemPath').value = config.system_path || '';
            document.getElementById('backupPath').value = config.backup_path || '';
            document.getElementById('externPath').value = config.extern_path || '';
            document.getElementById('launchPath').value = config.launch_path || '';
            document.getElementById('networkNat').value = config.network_nat || '';
            document.getElementById('networkPub').value = config.network_pub || '';
            document.getElementById('iKuaiAddr').value = config.i_kuai_addr || '';
            document.getElementById('iKuaiUser').value = config.i_kuai_user || '';
            document.getElementById('iKuaiPass').value = config.i_kuai_pass || '';
            document.getElementById('portsStart').value = config.ports_start || '';
            document.getElementById('portsClose').value = config.ports_close || '';
            document.getElementById('remotePort').value = config.remote_port || '';
            loadSystemMapsData(config.system_maps || {});
            document.getElementById('publicAddr').value = (config.public_addr || []).join(', ');
            document.getElementById('extendData').value = config.extend_data ? JSON.stringify(config.extend_data, null, 2) : '';
            document.getElementById('hostModal').showModal();
        }
    }
    
    // 删除主机
    function deleteHost(name) {
        currentDeleteHost = name;
        document.getElementById('deleteHostName').textContent = name;
        document.getElementById('deleteModal').showModal();
    }
    
    // 确认删除主机
    async function confirmDeleteHost() {
        if (!currentDeleteHost) return;
        
        const result = await apiRequest(`/api/hosts/${currentDeleteHost}`, 'DELETE');
        if (result && result.code === 200) {
            showToast('主机已删除', 'success');
            document.getElementById('deleteModal').close();
            loadHosts();
        } else {
            showToast(result?.msg || '删除失败', 'error');
        }
        currentDeleteHost = '';
    }
    
    // 切换主机状态
    async function toggleHost(name, enable) {
        const result = await apiRequest(`/api/hosts/${name}/power`, 'POST', { enable });
        if (result && result.code === 200) {
            showToast(result.msg, 'success');
            loadHosts();
        } else {
            showToast(result?.msg || '操作失败', 'error');
        }
    }
    
    // 扫描主机上的虚拟机
    async function scanHostVMs(hostName) {
        // 显示扫描中状态
        Swal.fire({
            title: '扫描中...',
            html: `正在扫描主机 "<strong>${hostName}</strong>" 上的虚拟机`,
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        try {
            const result = await apiRequest(`/api/hosts/${hostName}/vms/scan`, 'POST', {});
            
            if (result && result.code === 200) {
                const data = result.data || {};
                const scanned = data.scanned || 0;
                const added = data.added || 0;
                
                Swal.fire({
                    icon: 'success',
                    title: '扫描完成',
                    html: `扫描到 <strong>${scanned}</strong> 台虚拟机<br>新增 <strong>${added}</strong> 台虚拟机`,
                    timer: 3000,
                    showConfirmButton: true,
                    confirmButtonText: '确定'
                });
                
                // 刷新主机列表以更新虚拟机数量
                loadHosts();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '扫描失败',
                    text: result?.msg || '扫描虚拟机失败，请重试'
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: '扫描失败',
                text: '网络错误或服务器异常'
            });
        }
    }
    
    // 表单提交
    document.getElementById('hostForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const editMode = document.getElementById('editMode').value;
        const name = document.getElementById('hostName').value;
        const type = document.getElementById('hostType').value;
        
        const config = {
            server_type: type,
            server_addr: document.getElementById('serverAddr').value,
            server_user: document.getElementById('serverUser').value,
            server_pass: document.getElementById('serverPass').value,
            filter_name: document.getElementById('filterName').value,
            images_path: document.getElementById('imagesPath').value,
            system_path: document.getElementById('systemPath').value,
            backup_path: document.getElementById('backupPath').value,
            extern_path: document.getElementById('externPath').value,
            launch_path: document.getElementById('launchPath').value,
            network_nat: document.getElementById('networkNat').value,
            network_pub: document.getElementById('networkPub').value,
            i_kuai_addr: document.getElementById('iKuaiAddr').value,
            i_kuai_user: document.getElementById('iKuaiUser').value,
            i_kuai_pass: document.getElementById('iKuaiPass').value,
            ports_start: parseInt(document.getElementById('portsStart').value) || 0,
            ports_close: parseInt(document.getElementById('portsClose').value) || 0,
            remote_port: parseInt(document.getElementById('remotePort').value) || 0,
            system_maps: getSystemMapsData(),
            public_addr: document.getElementById('publicAddr').value.split(',').map(s => s.trim()).filter(s => s),
            extend_data: parseExtendData(document.getElementById('extendData').value)
        };
        
        let result;
        if (editMode === 'add') {
            result = await apiRequest('/api/hosts', 'POST', { name, type, config });
        } else {
            const originalName = document.getElementById('originalName').value;
            result = await apiRequest(`/api/hosts/${originalName}`, 'PUT', { config });
        }
        
        if (result && result.code === 200) {
            showToast(editMode === 'add' ? '主机添加成功' : '主机更新成功', 'success');
            document.getElementById('hostModal').close();
            loadHosts();
        } else {
            showToast(result?.msg || '操作失败', 'error');
        }
    });
</script>
{% endblock %}
