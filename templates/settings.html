{% extends "base.html" %}

{% block content %}
<!-- 页面标题 -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
        <span class="iconify text-gray-600" data-icon="mdi:cog" data-width="36"></span>
        系统设置
    </h1>
    <p class="text-gray-600 mt-1">管理访问Token和系统配置</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Token管理 -->
    <div class="bg-white rounded-lg border border-gray-200 card-hover">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                <span class="iconify text-blue-600" data-icon="mdi:key" data-width="20"></span>
                访问Token管理
            </h2>
        </div>
        <div class="p-4 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">当前Token</label>
                <div class="flex gap-2">
                    <input type="password" id="currentToken" readonly
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    <button onclick="toggleTokenVisibility()" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50" title="显示/隐藏">
                        <span class="iconify" data-icon="mdi:eye" data-width="20" id="toggleIcon"></span>
                    </button>
                    <button onclick="copyToken()" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50" title="复制">
                        <span class="iconify" data-icon="mdi:content-copy" data-width="20"></span>
                    </button>
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">设置新Token</label>
                <div class="flex gap-2">
                    <input type="text" id="newToken" placeholder="留空则自动生成随机Token"
                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="setNewToken()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2">
                        <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                        设置
                    </button>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="resetToken()" class="flex-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg flex items-center justify-center gap-2">
                    <span class="iconify" data-icon="mdi:refresh" data-width="18"></span>
                    重置Token
                </button>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <div class="flex items-start gap-2">
                    <span class="iconify text-yellow-600 mt-0.5" data-icon="mdi:alert" data-width="18"></span>
                    <div class="text-sm text-yellow-800">
                        <p class="font-medium">安全提示</p>
                        <p class="mt-1">重置Token后，所有使用旧Token的API调用都将失效。请确保更新所有相关配置。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API文档 -->
    <div class="bg-white rounded-lg border border-gray-200 card-hover">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                <span class="iconify text-green-600" data-icon="mdi:api" data-width="20"></span>
                API接口说明
            </h2>
        </div>
        <div class="p-4">
            <div class="space-y-3 text-sm">
                <div class="bg-gray-50 rounded-lg p-3">
                    <p class="font-medium text-gray-800 mb-1">认证方式</p>
                    <p class="text-gray-600">在请求头中添加：</p>
                    <code class="block mt-1 bg-gray-200 px-2 py-1 rounded text-xs">Authorization: Bearer YOUR_TOKEN</code>
                </div>
                
                <div class="border-t border-gray-200 pt-3">
                    <p class="font-medium text-gray-800 mb-2">主要接口</p>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">GET</span>
                            <code class="text-xs text-gray-600">/api/hosts</code>
                            <span class="text-xs text-gray-500">- 获取主机列表</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">POST</span>
                            <code class="text-xs text-gray-600">/api/hosts</code>
                            <span class="text-xs text-gray-500">- 添加主机</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs font-medium">GET</span>
                            <code class="text-xs text-gray-600">/api/hosts/{name}/vms</code>
                            <span class="text-xs text-gray-500">- 获取虚拟机列表</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">POST</span>
                            <code class="text-xs text-gray-600">/api/hosts/{name}/vms</code>
                            <span class="text-xs text-gray-500">- 创建虚拟机</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">POST</span>
                            <code class="text-xs text-gray-600">/api/hosts/{name}/vms/{uuid}/power</code>
                            <span class="text-xs text-gray-500">- 电源操作</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统操作 -->
    <div class="bg-white rounded-lg border border-gray-200 card-hover">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                <span class="iconify text-purple-600" data-icon="mdi:database" data-width="20"></span>
                数据管理
            </h2>
        </div>
        <div class="p-4 space-y-3">
            <button onclick="saveConfig()" class="w-full flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-green-300 hover:bg-green-50 smooth-transition">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                    <span class="iconify text-green-600" data-icon="mdi:content-save" data-width="20"></span>
                </div>
                <div class="flex-1 text-left">
                    <p class="text-sm font-semibold text-gray-800">保存配置</p>
                    <p class="text-xs text-gray-600">将当前配置保存到文件</p>
                </div>
            </button>
            
            <button onclick="loadConfig()" class="w-full flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 smooth-transition">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <span class="iconify text-blue-600" data-icon="mdi:folder-open" data-width="20"></span>
                </div>
                <div class="flex-1 text-left">
                    <p class="text-sm font-semibold text-gray-800">重新加载配置</p>
                    <p class="text-xs text-gray-600">从文件重新加载配置</p>
                </div>
            </button>
        </div>
    </div>

    <!-- 系统信息 -->
    <div class="bg-white rounded-lg border border-gray-200 card-hover">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                <span class="iconify text-gray-600" data-icon="mdi:information" data-width="20"></span>
                系统信息
            </h2>
        </div>
        <div class="p-4">
            <div class="space-y-3 text-sm">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">系统名称</span>
                    <span class="font-medium text-gray-800">OpenIDCS</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">版本</span>
                    <span class="font-medium text-gray-800">1.0.0</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">主机数量</span>
                    <span class="font-medium text-gray-800" id="infoHostCount">-</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">虚拟机数量</span>
                    <span class="font-medium text-gray-800" id="infoVmCount">-</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let tokenVisible = false;
    let currentTokenValue = '';

    $(document).ready(function() {
        loadCurrentToken();
        loadSystemInfo();
    });

    async function loadCurrentToken() {
        const result = await apiRequest('/api/token/current');
        if (result && result.code === 200) {
            currentTokenValue = result.data.token;
            document.getElementById('currentToken').value = '••••••••••••••••';
        }
    }

    async function loadSystemInfo() {
        const result = await apiRequest('/api/system/stats');
        if (result && result.code === 200) {
            document.getElementById('infoHostCount').textContent = result.data.host_count || 0;
            document.getElementById('infoVmCount').textContent = result.data.vm_count || 0;
        }
    }

    function toggleTokenVisibility() {
        tokenVisible = !tokenVisible;
        const input = document.getElementById('currentToken');
        const icon = document.getElementById('toggleIcon');
        
        if (tokenVisible) {
            input.value = currentTokenValue;
            input.type = 'text';
            icon.setAttribute('data-icon', 'mdi:eye-off');
        } else {
            input.value = '••••••••••••••••';
            input.type = 'password';
            icon.setAttribute('data-icon', 'mdi:eye');
        }
    }

    function copyToken() {
        navigator.clipboard.writeText(currentTokenValue).then(() => {
            showToast('Token已复制到剪贴板', 'success');
        });
    }

    async function setNewToken() {
        const newToken = document.getElementById('newToken').value;
        const result = await apiRequest('/api/token/set', 'POST', { token: newToken });
        
        if (result && result.code === 200) {
            currentTokenValue = result.data.token;
            document.getElementById('newToken').value = '';
            document.getElementById('currentToken').value = tokenVisible ? currentTokenValue : '••••••••••••••••';
            showToast('Token设置成功', 'success');
        } else {
            showToast(result?.msg || '设置失败', 'error');
        }
    }

    async function resetToken() {
        if (!confirm('确定要重置Token吗？所有使用旧Token的API调用都将失效。')) return;
        
        const result = await apiRequest('/api/token/reset', 'POST');
        if (result && result.code === 200) {
            currentTokenValue = result.data.token;
            document.getElementById('currentToken').value = tokenVisible ? currentTokenValue : '••••••••••••••••';
            showToast('Token已重置: ' + currentTokenValue, 'success');
        } else {
            showToast(result?.msg || '重置失败', 'error');
        }
    }

    async function saveConfig() {
        const result = await apiRequest('/api/system/save', 'POST');
        if (result && result.code === 200) {
            showToast('配置已保存', 'success');
        } else {
            showToast(result?.msg || '保存失败', 'error');
        }
    }

    async function loadConfig() {
        if (!confirm('确定要重新加载配置吗？未保存的更改将丢失。')) return;
        
        const result = await apiRequest('/api/system/load', 'POST');
        if (result && result.code === 200) {
            showToast('配置已重新加载', 'success');
            loadSystemInfo();
        } else {
            showToast(result?.msg || '加载失败', 'error');
        }
    }
</script>
{% endblock %}
