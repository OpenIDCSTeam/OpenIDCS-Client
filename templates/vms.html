{% extends "base.html" %}

{% block content %}
<!-- 页面标题 -->
<div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
        <a href="/hosts" class="hover:text-blue-600">主机管理</a>
        <span class="iconify" data-icon="mdi:chevron-right" data-width="16"></span>
        <span class="text-gray-700">{{ hs_name }}</span>
    </div>
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
        <span class="iconify text-purple-600" data-icon="mdi:cube-outline" data-width="36"></span>
        虚拟机管理
    </h1>
    <p class="text-gray-600 mt-1">管理主机 <span class="font-medium text-gray-800">{{ hs_name }}</span> 下的所有虚拟机</p>
</div>

<!-- 操作栏 -->
<div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
    <div class="flex items-center gap-4">
        <button onclick="openAddVMModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium btn-hover shadow-sm flex items-center gap-2">
            <span class="iconify" data-icon="mdi:plus" data-width="18"></span>
            创建虚拟机
        </button>
        <button onclick="loadVMs()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium btn-hover flex items-center gap-2">
            <span class="iconify" data-icon="mdi:refresh" data-width="18"></span>
            刷新
        </button>
        <a href="/hosts" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium btn-hover flex items-center gap-2">
            <span class="iconify" data-icon="mdi:arrow-left" data-width="18"></span>
            返回主机列表
        </a>
    </div>
    <div class="text-sm text-gray-500 flex items-center gap-2">
        <span class="iconify" data-icon="mdi:information-outline" data-width="16"></span>
        共 <span id="vmCount" class="font-medium text-gray-700">0</span> 台虚拟机
    </div>
</div>

<!-- 虚拟机列表 -->
<div id="vmsList" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="col-span-full text-center py-16 text-gray-500">
        <span class="iconify animate-pulse-slow text-gray-400" data-icon="mdi:loading" data-width="48"></span>
        <p class="mt-4">加载中...</p>
    </div>
</div>

<!-- 创建/编辑虚拟机模态框 -->
<dialog id="vmModal" class="modal">
    <div class="modal-box max-w-3xl">
        <h3 class="font-bold text-lg flex items-center gap-2" id="vmModalTitle">
            <span class="iconify text-purple-600" data-icon="mdi:cube-outline" data-width="24"></span>
            创建虚拟机
        </h3>
        <form id="vmForm" class="mt-4 space-y-4">
            <input type="hidden" name="editMode" id="vmEditMode" value="add">
            <input type="hidden" name="originalUuid" id="originalUuid" value="">
            
            <!-- 基本信息 -->
            <div class="border border-gray-200 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:information" data-width="18"></span>
                    基本信息
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">虚拟机UUID *</label>
                        <input type="text" name="vm_uuid" id="vmUuid" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="例如: vm_test001">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">操作系统</label>
                        <select name="os_name" id="osName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">请选择</option>
                            <option value="windows10x64">Windows 10 x64</option>
                            <option value="windows11x64">Windows 11 x64</option>
                            <option value="ubuntu2204">Ubuntu 22.04</option>
                            <option value="centos7">CentOS 7</option>
                            <option value="debian11">Debian 11</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 资源配置 -->
            <div class="border border-gray-200 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:chip" data-width="18"></span>
                    资源配置
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">CPU核心数</label>
                        <input type="number" name="cpu_num" id="cpuNum" min="1" max="32" value="2"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">内存(MB)</label>
                        <input type="number" name="mem_num" id="memNum" min="512" step="512" value="2048"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">硬盘(MB)</label>
                        <input type="number" name="hdd_num" id="hddNum" min="1024" step="1024" value="20480"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">GPU数量</label>
                        <input type="number" name="gpu_num" id="gpuNum" min="0" max="4" value="0"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>
            </div>
            
            <!-- 网络配置 -->
            <div class="border border-gray-200 rounded-lg p-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:ethernet" data-width="18"></span>
                    网络配置
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">上行带宽(Mbps)</label>
                        <input type="number" name="speed_u" id="speedU" min="1" value="100"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">下行带宽(Mbps)</label>
                        <input type="number" name="speed_d" id="speedD" min="1" value="100"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">NAT端口数</label>
                        <input type="number" name="nat_num" id="natNum" min="0" value="10"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">流量限制(MB)</label>
                        <input type="number" name="flu_num" id="fluNum" min="0" value="0"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>
                
                <!-- 网卡配置 -->
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-gray-600">网卡列表</span>
                        <button type="button" onclick="addNicConfig()" class="text-purple-600 hover:text-purple-800 text-sm flex items-center gap-1">
                            <span class="iconify" data-icon="mdi:plus" data-width="16"></span>
                            添加网卡
                        </button>
                    </div>
                    <div id="nicConfigs" class="space-y-2">
                        <!-- 动态添加网卡配置 -->
                    </div>
                </div>
            </div>
            
            <div class="modal-action">
                <button type="button" onclick="document.getElementById('vmModal').close()" 
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit" 
                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    保存
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 电源操作模态框 -->
<dialog id="powerModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg flex items-center gap-2">
            <span class="iconify text-purple-600" data-icon="mdi:power" data-width="24"></span>
            电源操作
        </h3>
        <p class="py-2 text-gray-600">选择对虚拟机 "<span id="powerVmName" class="font-medium text-gray-800"></span>" 执行的操作：</p>
        <div class="grid grid-cols-2 gap-3 mt-4">
            <button onclick="executePower('start')" class="btn bg-green-500 hover:bg-green-600 text-white flex items-center justify-center gap-2">
                <span class="iconify" data-icon="mdi:play" data-width="20"></span>
                启动
            </button>
            <button onclick="executePower('stop')" class="btn bg-yellow-500 hover:bg-yellow-600 text-white flex items-center justify-center gap-2">
                <span class="iconify" data-icon="mdi:stop" data-width="20"></span>
                关机
            </button>
            <button onclick="executePower('hard_stop')" class="btn bg-red-500 hover:bg-red-600 text-white flex items-center justify-center gap-2">
                <span class="iconify" data-icon="mdi:power-off" data-width="20"></span>
                强制关机
            </button>
            <button onclick="executePower('reset')" class="btn bg-blue-500 hover:bg-blue-600 text-white flex items-center justify-center gap-2">
                <span class="iconify" data-icon="mdi:restart" data-width="20"></span>
                重启
            </button>
            <button onclick="executePower('pause')" class="btn bg-gray-500 hover:bg-gray-600 text-white flex items-center justify-center gap-2">
                <span class="iconify" data-icon="mdi:pause" data-width="20"></span>
                暂停
            </button>
            <button onclick="executePower('resume')" class="btn bg-indigo-500 hover:bg-indigo-600 text-white flex items-center justify-center gap-2">
                <span class="iconify" data-icon="mdi:play-pause" data-width="20"></span>
                恢复
            </button>
        </div>
        <div class="modal-action">
            <button onclick="document.getElementById('powerModal').close()" 
                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 删除确认模态框 -->
<dialog id="vmDeleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg flex items-center gap-2 text-red-600">
            <span class="iconify" data-icon="mdi:alert-circle" data-width="24"></span>
            确认删除
        </h3>
        <p class="py-4">确定要删除虚拟机 "<span id="deleteVmName" class="font-medium"></span>" 吗？此操作不可恢复。</p>
        <div class="modal-action">
            <button onclick="document.getElementById('vmDeleteModal').close()" 
                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="confirmDeleteVM()" 
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                确认删除
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>
{% endblock %}

{% block extra_scripts %}
<script>
    const hostName = '{{ hs_name }}';
    let currentPowerVm = '';
    let currentDeleteVm = '';
    let nicCounter = 0;
    
    // 状态文字映射
    const statusMap = {
        'STOPPED': { text: '已停止', color: 'text-gray-600 bg-gray-100' },
        'STARTED': { text: '运行中', color: 'text-green-700 bg-green-100', pulse: true },
        'SUSPEND': { text: '已暂停', color: 'text-yellow-700 bg-yellow-100' },
        'ON_STOP': { text: '停止中', color: 'text-orange-600 bg-orange-100' },
        'ON_OPEN': { text: '启动中', color: 'text-blue-600 bg-blue-100' },
        'CRASHED': { text: '已崩溃', color: 'text-red-700 bg-red-100' },
        'UNKNOWN': { text: '未知', color: 'text-gray-500 bg-gray-100' }
    };
    
    $(document).ready(function() {
        loadVMs();
    });
    
    // 加载虚拟机列表
    async function loadVMs() {
        const container = document.getElementById('vmsList');
        container.innerHTML = `
            <div class="col-span-full text-center py-16 text-gray-500">
                <span class="iconify animate-pulse-slow text-gray-400" data-icon="mdi:loading" data-width="48"></span>
                <p class="mt-4">加载中...</p>
            </div>
        `;
        
        const result = await apiRequest(`/api/hosts/${hostName}/vms`);
        if (result && result.code === 200) {
            const vms = result.data;
            const count = Object.keys(vms).length;
            document.getElementById('vmCount').textContent = count;
            
            if (count === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <span class="iconify text-gray-300" data-icon="mdi:cube-off-outline" data-width="64"></span>
                        <p class="mt-4 text-gray-500">暂无虚拟机</p>
                        <button onclick="openAddVMModal()" class="mt-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">
                            创建第一台虚拟机
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            for (const [uuid, vm] of Object.entries(vms)) {
                container.innerHTML += renderVMCard(uuid, vm);
            }
        }
    }
    
    // 渲染虚拟机卡片
    function renderVMCard(uuid, vm) {
        const config = vm.config || {};
        const status = vm.status || {};
        const powerStatus = status.power_status || 'UNKNOWN';
        const statusInfo = statusMap[powerStatus] || statusMap['UNKNOWN'];
        
        return `
            <div class="bg-white rounded-lg border border-gray-200 card-hover overflow-hidden">
                <div class="p-4">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                                <span class="iconify text-white" data-icon="mdi:cube-outline" data-width="28"></span>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">${uuid}</h3>
                                <p class="text-sm text-gray-500">${config.os_name || '未知系统'}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium ${statusInfo.color} rounded-full flex items-center gap-1">
                            ${statusInfo.pulse ? '<span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>' : ''}
                            ${statusInfo.text}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="flex items-center gap-2 text-gray-600">
                            <span class="iconify" data-icon="mdi:chip" data-width="16"></span>
                            <span>CPU: <span class="font-medium text-gray-800">${config.cpu_num || 0} 核</span></span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-600">
                            <span class="iconify" data-icon="mdi:memory" data-width="16"></span>
                            <span>内存: <span class="font-medium text-gray-800">${formatMemory(config.mem_num)}</span></span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-600">
                            <span class="iconify" data-icon="mdi:harddisk" data-width="16"></span>
                            <span>硬盘: <span class="font-medium text-gray-800">${formatDisk(config.hdd_num)}</span></span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-600">
                            <span class="iconify" data-icon="mdi:ethernet" data-width="16"></span>
                            <span>带宽: <span class="font-medium text-gray-800">${config.speed_u || 0}/${config.speed_d || 0} Mbps</span></span>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 px-4 py-3 bg-gray-50 flex items-center justify-between">
                    <button onclick="showVMStatus('${uuid}')" class="text-purple-600 hover:text-purple-800 text-sm font-medium flex items-center gap-1">
                        <span class="iconify" data-icon="mdi:information-outline" data-width="16"></span>
                        查看详情
                    </button>
                    <div class="flex items-center gap-2">
                        <button onclick="openPowerModal('${uuid}')" 
                            class="p-2 rounded-lg hover:bg-gray-200 text-gray-600" title="电源管理">
                            <span class="iconify" data-icon="mdi:power" data-width="18"></span>
                        </button>
                        <button onclick="editVM('${uuid}')" 
                            class="p-2 rounded-lg hover:bg-gray-200 text-gray-600" title="编辑">
                            <span class="iconify" data-icon="mdi:pencil" data-width="18"></span>
                        </button>
                        <button onclick="deleteVM('${uuid}')" 
                            class="p-2 rounded-lg hover:bg-red-100 text-red-600" title="删除">
                            <span class="iconify" data-icon="mdi:delete" data-width="18"></span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // 格式化内存显示
    function formatMemory(mb) {
        if (!mb) return '0 MB';
        if (mb >= 1024) return `${(mb / 1024).toFixed(1)} GB`;
        return `${mb} MB`;
    }
    
    // 格式化磁盘显示
    function formatDisk(mb) {
        if (!mb) return '0 MB';
        if (mb >= 1024) return `${(mb / 1024).toFixed(1)} GB`;
        return `${mb} MB`;
    }
    
    // 打开创建虚拟机模态框
    function openAddVMModal() {
        document.getElementById('vmModalTitle').innerHTML = `
            <span class="iconify text-purple-600" data-icon="mdi:cube-outline" data-width="24"></span>
            创建虚拟机
        `;
        document.getElementById('vmEditMode').value = 'add';
        document.getElementById('vmForm').reset();
        document.getElementById('vmUuid').disabled = false;
        document.getElementById('nicConfigs').innerHTML = '';
        nicCounter = 0;
        addNicConfig();
        document.getElementById('vmModal').showModal();
    }
    
    // 添加网卡配置
    function addNicConfig() {
        nicCounter++;
        const container = document.getElementById('nicConfigs');
        const nicHtml = `
            <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg" id="nic_${nicCounter}">
                <input type="text" name="nic_name_${nicCounter}" placeholder="网卡名称 如: ethernet0"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                <select name="nic_type_${nicCounter}" class="px-2 py-1 text-sm border border-gray-300 rounded">
                    <option value="nat">NAT</option>
                    <option value="bridged">桥接</option>
                    <option value="host-only">仅主机</option>
                </select>
                <input type="text" name="nic_ip_${nicCounter}" placeholder="IP地址"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                <button type="button" onclick="removeNicConfig(${nicCounter})" class="p-1 text-red-500 hover:bg-red-50 rounded">
                    <span class="iconify" data-icon="mdi:close" data-width="16"></span>
                </button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', nicHtml);
    }
    
    // 移除网卡配置
    function removeNicConfig(id) {
        document.getElementById(`nic_${id}`).remove();
    }
    
    // 编辑虚拟机
    async function editVM(uuid) {
        const result = await apiRequest(`/api/hosts/${hostName}/vms/${uuid}`);
        if (result && result.code === 200) {
            const vm = result.data;
            const config = vm.config || {};
            
            document.getElementById('vmModalTitle').innerHTML = `
                <span class="iconify text-purple-600" data-icon="mdi:cube-outline" data-width="24"></span>
                编辑虚拟机
            `;
            document.getElementById('vmEditMode').value = 'edit';
            document.getElementById('originalUuid').value = uuid;
            document.getElementById('vmUuid').value = uuid;
            document.getElementById('vmUuid').disabled = true;
            document.getElementById('osName').value = config.os_name || '';
            document.getElementById('cpuNum').value = config.cpu_num || 2;
            document.getElementById('memNum').value = config.mem_num || 2048;
            document.getElementById('hddNum').value = config.hdd_num || 20480;
            document.getElementById('gpuNum').value = config.gpu_num || 0;
            document.getElementById('speedU').value = config.speed_u || 100;
            document.getElementById('speedD').value = config.speed_d || 100;
            document.getElementById('natNum').value = config.nat_num || 0;
            document.getElementById('fluNum').value = config.flu_num || 0;
            
            // 加载网卡配置
            document.getElementById('nicConfigs').innerHTML = '';
            nicCounter = 0;
            const nicAll = config.nic_all || {};
            for (const [nicName, nicConfig] of Object.entries(nicAll)) {
                nicCounter++;
                const nicHtml = `
                    <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg" id="nic_${nicCounter}">
                        <input type="text" name="nic_name_${nicCounter}" value="${nicName}" placeholder="网卡名称"
                            class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                        <select name="nic_type_${nicCounter}" class="px-2 py-1 text-sm border border-gray-300 rounded">
                            <option value="nat" ${nicConfig.nic_type === 'nat' ? 'selected' : ''}>NAT</option>
                            <option value="bridged" ${nicConfig.nic_type === 'bridged' ? 'selected' : ''}>桥接</option>
                            <option value="host-only" ${nicConfig.nic_type === 'host-only' ? 'selected' : ''}>仅主机</option>
                        </select>
                        <input type="text" name="nic_ip_${nicCounter}" value="${nicConfig.ip4_addr || ''}" placeholder="IP地址"
                            class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                        <button type="button" onclick="removeNicConfig(${nicCounter})" class="p-1 text-red-500 hover:bg-red-50 rounded">
                            <span class="iconify" data-icon="mdi:close" data-width="16"></span>
                        </button>
                    </div>
                `;
                document.getElementById('nicConfigs').insertAdjacentHTML('beforeend', nicHtml);
            }
            
            if (nicCounter === 0) addNicConfig();
            
            document.getElementById('vmModal').showModal();
        }
    }
    
    // 删除虚拟机
    function deleteVM(uuid) {
        currentDeleteVm = uuid;
        document.getElementById('deleteVmName').textContent = uuid;
        document.getElementById('vmDeleteModal').showModal();
    }
    
    // 确认删除虚拟机
    async function confirmDeleteVM() {
        if (!currentDeleteVm) return;
        
        const result = await apiRequest(`/api/hosts/${hostName}/vms/${currentDeleteVm}`, 'DELETE');
        if (result && result.code === 200) {
            showToast('虚拟机已删除', 'success');
            document.getElementById('vmDeleteModal').close();
            loadVMs();
        } else {
            showToast(result?.msg || '删除失败', 'error');
        }
        currentDeleteVm = '';
    }
    
    // 打开电源操作模态框
    function openPowerModal(uuid) {
        currentPowerVm = uuid;
        document.getElementById('powerVmName').textContent = uuid;
        document.getElementById('powerModal').showModal();
    }
    
    // 执行电源操作
    async function executePower(action) {
        if (!currentPowerVm) return;
        
        const result = await apiRequest(`/api/hosts/${hostName}/vms/${currentPowerVm}/power`, 'POST', { action });
        if (result && result.code === 200) {
            showToast(result.msg, 'success');
            document.getElementById('powerModal').close();
            setTimeout(loadVMs, 1000);
        } else {
            showToast(result?.msg || '操作失败', 'error');
        }
    }
    
    // 查看虚拟机状态
    async function showVMStatus(uuid) {
        const result = await apiRequest(`/api/hosts/${hostName}/vms/${uuid}/status`);
        if (result && result.code === 200) {
            const status = result.data;
            alert(JSON.stringify(status, null, 2));
        }
    }
    
    // 表单提交
    document.getElementById('vmForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const editMode = document.getElementById('vmEditMode').value;
        const uuid = document.getElementById('vmUuid').value;
        
        // 收集网卡配置
        const nicAll = {};
        const nicContainers = document.querySelectorAll('[id^="nic_"]');
        nicContainers.forEach((container, index) => {
            const nicName = container.querySelector(`[name^="nic_name_"]`).value;
            const nicType = container.querySelector(`[name^="nic_type_"]`).value;
            const nicIp = container.querySelector(`[name^="nic_ip_"]`).value;
            if (nicName) {
                nicAll[nicName] = {
                    nic_type: nicType,
                    ip4_addr: nicIp
                };
            }
        });
        
        const vmData = {
            vm_uuid: uuid,
            os_name: document.getElementById('osName').value,
            cpu_num: parseInt(document.getElementById('cpuNum').value) || 2,
            mem_num: parseInt(document.getElementById('memNum').value) || 2048,
            hdd_num: parseInt(document.getElementById('hddNum').value) || 20480,
            gpu_num: parseInt(document.getElementById('gpuNum').value) || 0,
            speed_u: parseInt(document.getElementById('speedU').value) || 100,
            speed_d: parseInt(document.getElementById('speedD').value) || 100,
            nat_num: parseInt(document.getElementById('natNum').value) || 0,
            flu_num: parseInt(document.getElementById('fluNum').value) || 0,
            nic_all: nicAll
        };
        
        let result;
        if (editMode === 'add') {
            result = await apiRequest(`/api/hosts/${hostName}/vms`, 'POST', vmData);
        } else {
            const originalUuid = document.getElementById('originalUuid').value;
            result = await apiRequest(`/api/hosts/${hostName}/vms/${originalUuid}`, 'PUT', vmData);
        }
        
        if (result && result.code === 200) {
            showToast(editMode === 'add' ? '虚拟机创建成功' : '虚拟机更新成功', 'success');
            document.getElementById('vmModal').close();
            loadVMs();
        } else {
            showToast(result?.msg || '操作失败', 'error');
        }
    });
</script>
{% endblock %}
