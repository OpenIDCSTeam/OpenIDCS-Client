{% extends "base.html" %}

{% block content %}
<!-- 页面标题 -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
        <span class="iconify text-blue-600" data-icon="mdi:view-dashboard" data-width="36"></span>
        仪表盘
    </h1>
    <p class="text-gray-600 mt-1">系统概览与快速操作</p>
</div>

<!-- 统计卡片 -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <!-- 主机统计 -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 card-hover">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:server" data-width="28"></span>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600 font-medium mb-1">主机总数</p>
                <p class="text-3xl font-bold text-gray-800" id="hostCount">-</p>
            </div>
        </div>
        <div class="pt-3 border-t border-gray-200">
            <a href="/hosts" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                管理主机
                <span class="iconify" data-icon="mdi:arrow-right" data-width="16"></span>
            </a>
        </div>
    </div>

    <!-- 虚拟机统计 -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 card-hover">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:cube-outline" data-width="28"></span>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600 font-medium mb-1">虚拟机总数</p>
                <p class="text-3xl font-bold text-gray-800" id="vmCount">-</p>
            </div>
        </div>
        <div class="pt-3 border-t border-gray-200 space-y-1">
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-600 flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    运行中
                </span>
                <span class="font-medium text-gray-800" id="runningVm">-</span>
            </div>
        </div>
    </div>

    <!-- 系统状态 -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 card-hover">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:check-circle" data-width="28"></span>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600 font-medium mb-1">系统状态</p>
                <p class="text-xl font-bold text-green-600">正常运行</p>
            </div>
        </div>
        <div class="pt-3 border-t border-gray-200">
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">最后更新</span>
                <span class="font-medium text-gray-800" id="lastUpdate">-</span>
            </div>
        </div>
    </div>
</div>

<!-- 主要内容区域 -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 主机列表 -->
    <div class="lg:col-span-2 bg-white rounded-lg border border-gray-200 card-hover">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                <span class="iconify text-blue-600" data-icon="mdi:format-list-bulleted" data-width="20"></span>
                主机概览
            </h2>
            <a href="/hosts" class="text-xs text-blue-600 hover:text-blue-800 font-medium smooth-transition flex items-center gap-1">
                查看全部
                <span class="iconify" data-icon="mdi:arrow-right" data-width="14"></span>
            </a>
        </div>
        <div id="hostsList" class="p-4">
            <p class="text-center py-8 text-gray-500 text-xs flex items-center justify-center gap-2">
                <span class="iconify animate-pulse-slow" data-icon="mdi:loading" data-width="16"></span>
                加载中...
            </p>
        </div>
    </div>

    <!-- 快速操作 -->
    <div class="bg-white rounded-lg border border-gray-200 card-hover">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                <span class="iconify text-blue-600" data-icon="mdi:lightning-bolt" data-width="20"></span>
                快速操作
            </h2>
        </div>
        <div class="p-4 space-y-3">
            <a href="/hosts" class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 smooth-transition group">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 smooth-transition">
                    <span class="iconify text-blue-600" data-icon="mdi:server-plus" data-width="20"></span>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-semibold text-gray-800">添加主机</p>
                    <p class="text-xs text-gray-600">添加新的虚拟化主机</p>
                </div>
                <span class="iconify text-gray-400 group-hover:text-blue-600 smooth-transition" data-icon="mdi:chevron-right" data-width="20"></span>
            </a>

            <a href="/settings" class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 smooth-transition group">
                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-gray-200 smooth-transition">
                    <span class="iconify text-gray-600" data-icon="mdi:cog" data-width="20"></span>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-semibold text-gray-800">系统设置</p>
                    <p class="text-xs text-gray-600">管理Token和系统配置</p>
                </div>
                <span class="iconify text-gray-400 group-hover:text-blue-600 smooth-transition" data-icon="mdi:chevron-right" data-width="20"></span>
            </a>

            <button onclick="saveAll()" class="w-full flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-green-300 hover:bg-green-50 smooth-transition group">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 smooth-transition">
                    <span class="iconify text-green-600" data-icon="mdi:content-save" data-width="20"></span>
                </div>
                <div class="flex-1 text-left">
                    <p class="text-sm font-semibold text-gray-800">保存配置</p>
                    <p class="text-xs text-gray-600">保存所有主机和虚拟机配置</p>
                </div>
                <span class="iconify text-gray-400 group-hover:text-green-600 smooth-transition" data-icon="mdi:chevron-right" data-width="20"></span>
            </button>

            <div class="border border-gray-200 rounded-lg p-3 bg-gradient-to-br from-blue-50 to-indigo-50">
                <div class="flex items-center gap-2 mb-2">
                    <span class="iconify text-blue-600" data-icon="mdi:information" data-width="16"></span>
                    <span class="text-xs font-semibold text-gray-700">提示</span>
                </div>
                <p class="text-xs text-gray-600 leading-relaxed">
                    通过<span class="font-medium text-blue-600">主机管理</span>页面可以管理主机和虚拟机。支持使用API+Token进行自动化管理。
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        loadDashboard();
        setInterval(loadDashboard, 30000);
    });

    async function loadDashboard() {
        try {
            const result = await apiRequest('/api/system/stats');
            if (result && result.code === 200) {
                const stats = result.data;
                $('#hostCount').text(stats.host_count || 0);
                $('#vmCount').text(stats.vm_count || 0);
                $('#runningVm').text(stats.running_vm_count || 0);
            }

            const hostsResult = await apiRequest('/api/hosts');
            if (hostsResult && hostsResult.code === 200) {
                renderHostsList(hostsResult.data);
            }

            const now = new Date();
            $('#lastUpdate').text(now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' }));
        } catch (error) {
            console.error('加载数据失败:', error);
        }
    }

    function renderHostsList(hosts) {
        const container = document.getElementById('hostsList');
        const hostsList = Object.entries(hosts);
        
        if (hostsList.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <span class="iconify text-gray-300" data-icon="mdi:server-off" data-width="48"></span>
                    <p class="mt-4 text-gray-500 text-sm">暂无主机</p>
                    <a href="/hosts" class="mt-2 inline-block text-blue-600 hover:text-blue-800 text-sm">添加主机</a>
                </div>
            `;
            return;
        }

        let html = '<div class="space-y-2">';
        hostsList.slice(0, 5).forEach(([name, host]) => {
            html += `
                <a href="/hosts/${name}/vms" class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 smooth-transition group">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
                            <span class="iconify text-white" data-icon="mdi:server" data-width="16"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-800 truncate">${name}</p>
                            <p class="text-xs text-gray-600 truncate">${host.addr || '未配置'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="text-xs text-gray-600">${host.vm_count || 0} 台VM</span>
                        <span class="iconify text-gray-400 group-hover:text-blue-600 smooth-transition" data-icon="mdi:chevron-right" data-width="16"></span>
                    </div>
                </a>
            `;
        });

        if (hostsList.length > 5) {
            html += `
                <a href="/hosts" class="flex items-center justify-center p-3 border border-gray-200 border-dashed rounded-lg hover:border-blue-300 hover:bg-blue-50 transition text-xs text-gray-600 hover:text-blue-600 font-medium">
                    查看全部 ${hostsList.length} 个主机 →
                </a>
            `;
        }

        html += '</div>';
        container.innerHTML = html;
    }

    async function saveAll() {
        const result = await apiRequest('/api/system/save', 'POST');
        if (result && result.code === 200) {
            showToast('配置已保存', 'success');
        } else {
            showToast(result?.msg || '保存失败', 'error');
        }
    }
</script>
{% endblock %}
